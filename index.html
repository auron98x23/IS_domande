<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Quiz Master</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <div class="header-wrapper">
        <h1>AI Quiz Master (1-138)</h1>
        
        <div class="score-box">
            <div class="score-item">âœ… Punti: <span id="score">0</span> / <span id="total-visible">0</span></div>
            <div class="score-item error-text">âŒ Errori: <span id="errors">0</span></div>
            <div class="score-item grade-text">ğŸ“ Voto: <span id="grade">0.0</span>/30</div>
        </div>

        <div id="error-panel" class="error-panel" style="display: none;">
            <span class="error-label">Indice Errori:</span>
            <div id="error-list" class="error-list"></div>
        </div>

        <div class="control-group">
            <span class="group-label">Blocchi Domande</span>
            <div class="btn-row">
                <button class="btn-block active" onclick="toggleBlock(1)" data-block="1">1-20</button>
                <button class="btn-block" onclick="toggleBlock(2)" data-block="2">21-40</button>
                <button class="btn-block" onclick="toggleBlock(3)" data-block="3">41-60</button>
                <button class="btn-block" onclick="toggleBlock(4)" data-block="4">61-80</button>
                <button class="btn-block" onclick="toggleBlock(5)" data-block="5">81-100</button>
                <button class="btn-block" onclick="toggleBlock(6)" data-block="6">101-120</button>
                <button class="btn-block" onclick="toggleBlock(7)" data-block="7">121-138</button>
                <button class="btn-block" onclick="selectAllBlocks()" style="border-color: #333; color: #333;">Tutte</button>
            </div>
            
            <div class="custom-range-wrapper">
                <span class="group-label">Oppure Range Manuale</span>
                <div class="custom-range-row">
                    <input type="number" id="start-range" placeholder="Da" min="1">
                    <input type="number" id="end-range" placeholder="A" min="1">
                    <button class="btn-block btn-apply" onclick="applyCustomRange()">Applica</button>
                </div>
            </div>
        </div>

        <div class="btn-row modes-row">
            <button class="btn-q" id="q-rand" onclick="setQMode('random')">ğŸ”€ Domande Random</button>
            <button class="btn-q mode-active" id="q-ord" onclick="setQMode('ordered')">ğŸ”¢ Domande Ordine</button>
            <button class="btn-a" id="a-rand" onclick="setAMode('random')">ğŸ”€ Risposte Random</button>
            <button class="btn-a mode-active" id="a-ord" onclick="setAMode('ordered')">ABC Risposte Ordine</button>
        </div>
        
        <div class="btn-row actions-row">
            <button class="btn-reset" onclick="resetProgress()">ğŸ—‘ï¸ Reset</button>
            <button class="btn-toggle-list" onclick="toggleErrorPanel()">ğŸ“‹ Lista Errori</button>
            <button class="btn-error-review" id="btn-review-mode" onclick="toggleErrorReviewMode()">âŒ Ripeti Errori</button>
        </div>
    </div>

    <div id="quiz-container">
        <p style="text-align: center; color: #666; padding: 20px;">Caricamento domande...</p>
    </div>
</div>

<button onclick="scrollToTop()" id="btn-back-to-top" class="btn-top" title="Torna su">â¬†ï¸</button>

<script>
let fullDb = [];
let activeBlocks = [1];
let score = 0;
let errors = 0; 
let attempted = new Set();
let correctFirstTry = new Set();
let questionsWithErrors = new Set(); 
let modeQ = 'ordered'; 
let modeA = 'ordered'; 
let currentQuizSet = [];

let useCustomRange = false;
let customStart = 1;
let customEnd = 138;

// NUOVO: ModalitÃ  revisione errori
let reviewErrorsMode = false;

const topBtn = document.getElementById("btn-back-to-top");
window.onscroll = function() {
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
        topBtn.style.display = "block";
    } else {
        topBtn.style.display = "none";
    }
};
function scrollToTop() {
    window.scrollTo({top: 0, behavior: 'smooth'});
}

async function loadAndInit() {
    try {
        const response = await fetch('questions.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        fullDb = await response.json();
        regenerateQuiz();
    } catch (error) {
        console.error(error);
        document.getElementById('quiz-container').innerHTML = "<p style='color:red;text-align:center'>Errore caricamento dati.</p>";
    }
}

function applyCustomRange() {
    const sVal = parseInt(document.getElementById('start-range').value);
    const eVal = parseInt(document.getElementById('end-range').value);
    if(!sVal || !eVal || sVal > eVal || sVal < 1) {
        alert("Range non valido.");
        return;
    }
    useCustomRange = true;
    reviewErrorsMode = false; // Disattiva modalitÃ  errori se cambio range
    customStart = sVal;
    customEnd = eVal;
    updateUIButtons();
    regenerateQuiz();
}

function toggleBlock(b) {
    useCustomRange = false;
    reviewErrorsMode = false; // Disattiva modalitÃ  errori se cambio blocco
    const btn = document.querySelector(`button[data-block="${b}"]`);
    if(activeBlocks.includes(b)) {
        if(activeBlocks.length > 1) {
            activeBlocks = activeBlocks.filter(x => x !== b);
        }
    } else {
        activeBlocks.push(b);
    }
    updateUIButtons();
    regenerateQuiz();
}

function selectAllBlocks() {
    useCustomRange = false;
    reviewErrorsMode = false;
    activeBlocks = [1,2,3,4,5,6,7];
    updateUIButtons();
    regenerateQuiz();
}

// NUOVO: Funzione per attivare/disattivare la modalitÃ  "Solo Errori"
function toggleErrorReviewMode() {
    if (questionsWithErrors.size === 0) {
        alert("Non hai ancora commesso errori da ripassare! Ottimo lavoro.");
        return;
    }
    reviewErrorsMode = !reviewErrorsMode;
    
    const btn = document.getElementById('btn-review-mode');
    if (reviewErrorsMode) {
        btn.innerHTML = "ğŸ”™ Torna al Quiz";
        btn.classList.add('active-review');
    } else {
        btn.innerHTML = "âŒ Ripeti Errori";
        btn.classList.remove('active-review');
    }
    
    // Aggiorna anche lo stato visuale degli altri bottoni
    updateUIButtons();
    regenerateQuiz();
}

function updateUIButtons() {
    // Gestisce lo stato "active" dei bottoni blocchi
    document.querySelectorAll('.btn-block').forEach(btn => {
        if (reviewErrorsMode) {
            btn.classList.remove('active');
            btn.style.opacity = '0.5'; // Li rende semitrasparenti in modalitÃ  review
        } else {
            btn.style.opacity = '1';
            const blk = parseInt(btn.getAttribute('data-block'));
            if (!isNaN(blk)) {
                if (activeBlocks.includes(blk) && !useCustomRange) btn.classList.add('active');
                else btn.classList.remove('active');
            } else if (btn.innerHTML === "Tutte") {
                 // Logica per bottone "Tutte" (semplific
